# -*- coding: utf-8 -*-
"""
Created on Thu Aug 16 20:52:25 2018

@author: Martin
"""

from py_digilab.solver import ode45

import numpy as np

def dQSSA(t,y):
    dydt = []
    k = [1,1,1,1]
    dydt.append(-k[0]*y[0]*y[1]+k[1]*y[2]            +k[3]*y[3])
    dydt.append(-k[0]*y[0]*y[1]+k[1]*y[2]+k[2]*y[2]            )
    dydt.append( k[0]*y[0]*y[1]-k[1]*y[2]-k[2]*y[2]            )
    dydt.append( k[2]*y[2]                           -k[3]*y[3])
    return np.asarray(dydt)

def test_ode45_tspan():
    t = [0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.01, 0.03, 0.04, 0.06, 0.09, 0.12,
         0.16, 0.21, 0.26, 0.31, 0.37, 0.44, 0.51, 0.59, 0.68, 0.78, 0.88,
         0.99, 1.11, 1.24, 1.37, 1.53, 1.69, 1.87, 2.07, 2.29, 2.53, 2.81,
         3.12, 3.45, 3.82, 4.21, 4.64, 5.12, 5.65, 6.24, 6.91, 7.7, 8.63, 9.76,
         11.18, 13.03, 14.82, 15.93, 17.01, 18.11, 19.25, 20.4, 21.55, 22.67,
         23.78, 24.88, 26.01, 27.14, 28.28, 29.41, 30.53, 31.64, 32.76, 33.89,
         35.02, 36.15, 37.28, 38.4, 39.52, 40.64, 41.77, 42.9, 44.02, 45.15,
         46.27, 47.39, 48.52, 49.65, 50.77, 51.89, 53.02, 54.14, 55.27, 56.39,
         57.52, 58.64, 59.77, 60.89, 62.02, 63.14, 64.27, 65.39, 66.52, 67.64,
         68.76, 69.89, 71.01, 72.14, 73.26, 74.39, 75.51, 76.64, 77.76, 78.89,
         80.01, 81.14, 82.26, 83.39, 84.51, 85.64, 86.76, 87.89, 89.01, 90.14,
         91.26, 92.38, 93.51, 94.63, 95.76, 96.88, 98.01, 99.13, 100.0]
    
    y = [[1.0, 1.0, 0.0, 0.0],
         [1.0, 1.0, 0.0, 0.0],
         [0.99, 0.99, 0.01, 0.0],
         [0.98, 0.98, 0.02, 0.0],
         [0.97, 0.97, 0.03, 0.0],
         [0.96, 0.96, 0.04, 0.0],
         [0.95, 0.96, 0.04, 0.0],
         [0.95, 0.95, 0.05, 0.0],
         [0.93, 0.93, 0.07, 0.0],
         [0.91, 0.92, 0.08, 0.0],
         [0.9, 0.91, 0.09, 0.01],
         [0.89, 0.89, 0.11, 0.01],
         [0.87, 0.88, 0.12, 0.01],
         [0.86, 0.87, 0.13, 0.01],
         [0.84, 0.86, 0.14, 0.02],
         [0.82, 0.84, 0.16, 0.02],
         [0.8, 0.83, 0.17, 0.03],
         [0.78, 0.82, 0.18, 0.03],
         [0.77, 0.81, 0.19, 0.04],
         [0.75, 0.8, 0.2, 0.05],
         [0.74, 0.79, 0.21, 0.05],
         [0.72, 0.78, 0.22, 0.06],
         [0.7, 0.77, 0.23, 0.08],
         [0.68, 0.77, 0.23, 0.09],
         [0.66, 0.76, 0.24, 0.1],
         [0.65, 0.76, 0.24, 0.11],
         [0.64, 0.76, 0.24, 0.12],
         [0.63, 0.76, 0.24, 0.13],
         [0.62, 0.76, 0.24, 0.14],
         [0.6, 0.76, 0.24, 0.16],
         [0.6, 0.76, 0.24, 0.17],
         [0.59, 0.77, 0.23, 0.18],
         [0.58, 0.77, 0.23, 0.19],
         [0.58, 0.77, 0.23, 0.19],
         [0.58, 0.77, 0.23, 0.2],
         [0.57, 0.78, 0.22, 0.21],
         [0.57, 0.78, 0.22, 0.21],
         [0.57, 0.78, 0.22, 0.21],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22]]
    
    tout,yout = ode45(dQSSA,[0,100],[1,1,0,0])
    tout = [np.round(x,2) for x in tout]
    yout = [[np.round(b,2) for b in a] for a in yout]
    
    assert np.all(np.asarray(tout)==np.asarray(t))
    assert np.all(np.asarray(yout)==np.asarray(y))
    
def test_ode45_tvec():
    tspan = np.linspace(0,10,11)
    
    y = [[1.00, 1.00, 0.00, 0.00],
         [0.63, 0.76, 0.24, 0.13],
         [0.58, 0.77, 0.23, 0.19],
         [0.57, 0.78, 0.22, 0.21],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22]]
    
    tout,yout = ode45(dQSSA,tspan,[1,1,0,0])
    tout = [int(x*100)/100. for x in tout]
    yout = [[np.round(b,2) for b in a] for a in yout]
    
    assert np.all(np.asarray(yout)==np.asarray(y))