from py_digilab.solver import ode15s

import numpy as np

def dQSSA(t,y):
    dydt = []
    k = [1,1,1,1]
    dydt.append(-k[0]*y[0]*y[1]+k[1]*y[2]            +k[3]*y[3])
    dydt.append(-k[0]*y[0]*y[1]+k[1]*y[2]+k[2]*y[2]            )
    dydt.append( k[0]*y[0]*y[1]-k[1]*y[2]-k[2]*y[2]            )
    dydt.append( k[2]*y[2]                           -k[3]*y[3])
    return np.asarray(dydt)

def test_ode15s_tspan():
    t = [0.0, 0.0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.08, 0.1, 0.12, 0.14,
         0.16, 0.18, 0.21, 0.25, 0.29, 0.33, 0.37, 0.41, 0.45, 0.53, 0.61,
         0.68, 0.76, 0.84, 0.92, 1.0, 1.15, 1.31, 1.46, 1.62, 1.78, 1.93, 2.09,
         2.4, 2.71, 3.03, 3.65, 4.28, 5.53, 8.03, 13.03, 23.03, 43.03, 83.03,
         100.0]
    
    y = [[1.0, 1.0, 0.0, 0.0],
         [1.0, 1.0, 0.0, 0.0],
         [0.99, 0.99, 0.01, 0.0],
         [0.98, 0.98, 0.02, 0.0],
         [0.97, 0.97, 0.03, 0.0],
         [0.96, 0.96, 0.04, 0.0],
         [0.95, 0.96, 0.04, 0.0],
         [0.95, 0.95, 0.05, 0.0],
         [0.93, 0.93, 0.07, 0.0],
         [0.91, 0.92, 0.08, 0.0],
         [0.9, 0.91, 0.09, 0.01],
         [0.89, 0.89, 0.11, 0.01],
         [0.87, 0.88, 0.12, 0.01],
         [0.86, 0.87, 0.13, 0.01],
         [0.84, 0.86, 0.14, 0.02],
         [0.82, 0.84, 0.16, 0.02],
         [0.8, 0.83, 0.17, 0.03],
         [0.78, 0.82, 0.18, 0.03],
         [0.77, 0.81, 0.19, 0.04],
         [0.75, 0.8, 0.2, 0.05],
         [0.74, 0.79, 0.21, 0.05],
         [0.72, 0.78, 0.22, 0.06],
         [0.7, 0.77, 0.23, 0.08],
         [0.68, 0.77, 0.23, 0.09],
         [0.66, 0.76, 0.24, 0.1],
         [0.65, 0.76, 0.24, 0.11],
         [0.64, 0.76, 0.24, 0.12],
         [0.63, 0.76, 0.24, 0.13],
         [0.62, 0.76, 0.24, 0.14],
         [0.6, 0.76, 0.24, 0.16],
         [0.6, 0.76, 0.24, 0.17],
         [0.59, 0.77, 0.23, 0.18],
         [0.58, 0.77, 0.23, 0.19],
         [0.58, 0.77, 0.23, 0.19],
         [0.58, 0.77, 0.23, 0.2],
         [0.57, 0.78, 0.22, 0.21],
         [0.57, 0.78, 0.22, 0.21],
         [0.57, 0.78, 0.22, 0.21],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22]]
    
    tout,yout = ode15s(dQSSA,[0,100],[1,1,0,0])
    tout = [np.round(x,2) for x in tout]
    yout = [[np.round(b,2) for b in a] for a in yout]
    
    assert np.all(np.asarray(tout)==np.asarray(t))
    assert np.all(np.asarray(yout)==np.asarray(y))
    
def test_ode15s_tvec():
    tspan = np.linspace(0,10,11)
    
    y = [[1.0 , 1.0 , 0.0 , 0.0 ],
         [0.63, 0.76, 0.24, 0.13],
         [0.58, 0.77, 0.23, 0.19],
         [0.57, 0.78, 0.22, 0.21],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22],
         [0.56, 0.78, 0.22, 0.22]]
    
    tout,yout = ode15s(dQSSA,tspan,[1,1,0,0])
    yout = [[np.round(b,2) for b in a] for a in yout]
    
    assert np.all(np.asarray(yout)==np.asarray(y))